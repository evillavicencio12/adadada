{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% translate "Lista de Pagos" %}{% endblock %}

{% block extrastyles %}
{{ block.super }}
<style>
    body {
        /* background-color: #f8f9fa; Eliminado para heredar de base.html o usar uno más neutro si es necesario */
    }

    .page-header-custom {
        background: linear-gradient(135deg, #667eea, #764ba2); /* Gradiente más suave y profesional */
        color: white;
        padding: 2.5rem 1.5rem; /* Aumentar padding */
        margin-bottom: 2.5rem; /* Aumentar margen */
        border-radius: .75rem; /* Bordes redondeados */
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .page-header-custom h1 {
        font-weight: 300; /* Fuente más ligera para el título */
        font-size: 2.25rem;
    }
    .page-header-custom p {
        font-size: 1rem;
        opacity: 0.85;
    }

    .stats-card-custom {
        background: white;
        border-radius: .75rem;
        padding: 1.75rem; /* Aumentar padding */
        box-shadow: 0 4px 15px rgba(0,0,0,0.07); /* Sombra más sutil */
        margin-bottom: 2.5rem;
        border: 1px solid #e9ecef; /* Borde ligero */
    }

    .stat-item-custom .stat-number {
        font-size: 2.25rem; /* Ligeramente más grande */
        font-weight: 600; /* Más peso */
        color: #4a5568; /* Color de texto principal */
    }
    .stat-item-custom .stat-number.text-primary { /* Para un número destacado */
        color: #5a67d8;
    }

    .stat-item-custom .stat-label {
        color: #718096; /* Gris más oscuro para etiquetas */
        font-size: 0.875rem; /* Ligeramente más pequeño */
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .table-container-custom {
        background: white;
        border-radius: .75rem;
        padding: 2rem; /* Aumentar padding */
        box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        border: 1px solid #e9ecef;
    }

    .btn-nuevo-custom {
        background: #5a67d8; /* Color primario del tema */
        /* background: linear-gradient(135deg, #5a67d8, #7f5af0); */
        border: none;
        color: white;
        padding: 0.65rem 1.25rem; /* Ajustar padding */
        border-radius: .5rem; /* Bordes más suaves */
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .btn-nuevo-custom:hover {
        background: #4c51bf; /* Un poco más oscuro al hacer hover */
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        color: white;
    }

    .estado-badge { /* Estilo base común */
        padding: 0.35em 0.75em;
        border-radius: 50px; /* Más redondeado (píldora) */
        font-size: 0.78rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border: 1px solid transparent;
    }

    .estado-PENDIENTE { /* Usar los valores reales de los choices */
        background-color: #fff3cd; /* Amarillo Bootstrap para warning */
        color: #664d03;
        border-color: #ffecb5;
    }

    .estado-PAGADO {
        background-color: #d1e7dd; /* Verde Bootstrap para success */
        color: #0f5132;
        border-color: #badbcc;
    }

    .estado-CANCELADO { /* Asumiendo que podría haber un estado CANCELADO */
        background-color: #f8d7da; /* Rojo Bootstrap para danger */
        color: #58151c;
        border-color: #f1aeB5;
    }
    .estado-ANULADO { /* Otro posible estado */
        background-color: #e2e3e5; /* Gris Bootstrap para secondary */
        color: #41464b;
        border-color: #d3d6d8;
    }

    .search-box-custom .form-control,
    .filter-box-custom .form-select {
        border-radius: .5rem;
        font-size: 0.9rem;
        padding: .6rem 1rem;
    }
    .search-box-custom .input-group-text {
        border-radius: .5rem 0 0 .5rem;
    }

    .table th {
        font-weight: 600;
        color: #4a5568;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        border-bottom-width: 1px; /* Línea más fina */
    }
    .table td {
        vertical-align: middle;
        font-size: 0.9rem;
    }
    .table-hover tbody tr:hover {
        background-color: #f8f9fc; /* Hover más sutil */
    }

    .btn-action-custom {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
        border-radius: .375rem;
    }
    .btn-action-custom.btn-outline-primary:hover { color: white; }
    .btn-action-custom.btn-outline-danger:hover { color: white; }
    .btn-action-custom.btn-outline-info:hover { color: white; }

    .empty-state-custom {
        text-align: center;
        padding: 3rem 1.5rem;
        color: #a0aec0; /* Color de texto más suave */
    }

    .empty-state-custom i {
        font-size: 3.5rem; /* Icono más grande */
        margin-bottom: 1.5rem;
        opacity: 0.6;
    }
    .empty-state-custom h5{
        color: #4a5568;
        font-weight: 500;
    }
    .pagination .page-link {
        border-radius: .375rem;
        margin: 0 3px;
        color: #5a67d8;
        border-color: #e2e8f0;
    }
    .pagination .page-item.active .page-link {
        background-color: #5a67d8;
        border-color: #5a67d8;
        color: white;
    }
    .pagination .page-item.disabled .page-link {
        color: #a0aec0;
    }

</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="page-header-custom">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h1 class="mb-1">
                    <i class="fas fa-file-invoice-dollar me-3"></i>
                    {% translate "Gestión de Pagos" %}
                </h1>
                <p class="mb-0">{% translate "Administra los pagos de las consultas médicas y servicios." %}</p>
            </div>
            <div class="mt-3 mt-md-0">
                <a href="{% url 'doctor:pago_create' %}" class="btn btn-nuevo-custom">
                    <i class="fas fa-plus me-2"></i>
                    {% translate "Nuevo Pago" %}
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Estadísticas -->
    <div class="stats-card-custom">
        <div class="row text-center">
            <div class="col-md-3 col-6 stat-item-custom mb-3 mb-md-0">
                <div class="stat-number text-primary" id="totalPagos">{{ object_list.count }}</div>
                <div class="stat-label">{% translate "Total Pagos" %}</div>
            </div>
            <div class="col-md-3 col-6 stat-item-custom mb-3 mb-md-0">
                <div class="stat-number" id="pagosPendientes">{{ pagos_pendientes_count|default:0 }}</div> {# Asume que pasas esto desde la vista #}
                <div class="stat-label">{% translate "Pendientes" %}</div>
            </div>
            <div class="col-md-3 col-6 stat-item-custom">
                <div class="stat-number" id="pagosPagados">{{ pagos_pagados_count|default:0 }}</div> {# Asume que pasas esto desde la vista #}
                <div class="stat-label">{% translate "Pagados" %}</div>
            </div>
            <div class="col-md-3 col-6 stat-item-custom">
                <div class="stat-number" id="montoTotal">${{ total_recaudado|floatformat:2|default:"0.00" }}</div> {# Asume que pasas esto desde la vista #}
                <div class="stat-label">{% translate "Monto Recaudado" %}</div>
            </div>
        </div>
    </div>

    <!-- Controles y Tabla -->
    <div class="table-container-custom">
        <form method="get" class="mb-4">
            <div class="row g-3 align-items-center">
                <div class="col-md-5">
                    <label for="searchInput" class="form-label visually-hidden">{% translate "Buscar" %}</label>
                    <div class="input-group search-box-custom">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" name="q" value="{{ request.GET.q|default:'' }}" placeholder="{% translate 'Buscar por paciente, referencia...' %}" id="searchInput">
                    </div>
                </div>
                <div class="col-md-3 filter-box-custom">
                    <label for="estadoFilter" class="form-label visually-hidden">{% translate "Estado" %}</label>
                    <select class="form-select" name="estado" id="estadoFilter">
                        <option value="">{% translate "Todos los estados" %}</option>
                        {% for choice_val, choice_disp in estado_choices %} {# Asume que pasas estado_choices desde la vista #}
                            <option value="{{ choice_val }}" {% if request.GET.estado == choice_val %}selected{% endif %}>{{ choice_disp }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 filter-box-custom">
                     <label for="fechaFilter" class="form-label visually-hidden">{% translate "Fecha" %}</label>
                    <input type="date" class="form-control" name="fecha" value="{{ request.GET.fecha|default:'' }}" id="fechaFilter">
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-primary w-100">{% translate "Filtrar" %}</button>
                </div>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>{% translate "ID" %}</th>
                        <th>{% translate "Paciente" %}</th>
                        <th>{% translate "Atención" %}</th>
                        <th class="text-end">{% translate "Monto" %}</th>
                        <th class="text-center">{% translate "Estado" %}</th>
                        <th>{% translate "Método" %}</th>
                        <th>{% translate "Fecha Pago" %}</th>
                        <th class="text-center">{% translate "Acciones" %}</th>
                    </tr>
                </thead>
                <tbody id="pagosTableBody">
                    {% for pago in pagos %} {# 'pagos' es el context_object_name por defecto de ListView #}
                    <tr data-estado="{{ pago.estado }}">
                        <td>
                            <a href="{% url 'doctor:pago_detail' pago.pk %}" class="fw-bold text-decoration-none">#{{ pago.id|stringformat:"04d" }}</a>
                        </td>
                        <td>
                            {% if pago.atencion and pago.atencion.paciente %}
                                {{ pago.atencion.paciente.nombre_completo|default:pago.nombre_pagador|default:"N/A" }}
                            {% else %}
                                {{ pago.nombre_pagador|default:"N/A" }}
                            {% endif %}
                        </td>
                        <td>
                            {% if pago.atencion %}
                                <small class="text-muted">{{ pago.atencion.fecha_atencion_real|date:"d/m/y H:i" }}</small>
                            {% else %}
                                <small class="text-muted">N/A</small>
                            {% endif %}
                        </td>
                        <td class="text-end fw-semibold">${{ pago.monto_total|floatformat:2 }}</td>
                        <td class="text-center">
                            <span class="estado-badge estado-{{ pago.estado }}">
                                {{ pago.get_estado_display }}
                            </span>
                        </td>
                        <td>{{ pago.get_metodo_pago_display }}</td>
                        <td>
                            {% if pago.fecha_pago %}
                                {{ pago.fecha_pago|date:"d/m/Y" }}
                                <br><small class="text-muted">{{ pago.fecha_pago|time:"H:i" }}</small>
                            {% else %}
                                <span class="text-muted">--</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <a href="{% url 'doctor:pago_detail' pago.pk %}" class="btn btn-sm btn-outline-info btn-action-custom" title="{% translate 'Ver Detalles' %}">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{% url 'doctor:pago_update' pago.pk %}" class="btn btn-sm btn-outline-primary btn-action-custom" title="{% translate 'Editar' %}">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'doctor:pago_delete' pago.pk %}" class="btn btn-sm btn-outline-danger btn-action-custom" title="{% translate 'Eliminar' %}">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8">
                            <div class="empty-state-custom">
                                <i class="fas fa-file-invoice-dollar"></i>
                                <h5>{% translate "No hay pagos registrados" %}</h5>
                                <p>{% translate "Comienza creando tu primer pago o ajusta los filtros." %}</p>
                                <a href="{% url 'doctor:pago_create' %}" class="btn btn-nuevo-custom mt-2">
                                    <i class="fas fa-plus me-2"></i>
                                    {% translate "Crear Primer Pago" %}
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% include "fragments/pagination.html" with page_obj=page_obj %} {# Usar el nombre de contexto de paginación de Django #}

    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    // Los filtros ahora se manejan por el backend al hacer submit al form.
    // Si se quisiera filtrado en tiempo real sin recargar la página, se necesitaría AJAX.
    // El script de filtrado por JS que estaba aquí se ha eliminado para evitar confusión,
    // ya que ahora el formulario GET se encarga del filtrado.
</script>
{% endblock %}
