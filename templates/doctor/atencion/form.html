{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ view.model_name_title|default:"Gestión" }} - {% if object %}Editar{% else %}Crear{% endif %}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white shadow-xl rounded-lg p-8">
        <div class="flex justify-between items-center mb-6 pb-3 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fas fa-notes-medical mr-3 text-blue-500"></i>
                {% if object %}Editar{% else %}Nueva{% endif %} Atención Médica
            </h1>
            <a href="{% url 'doctor:atencion_list' %}" class="text-gray-600 hover:text-gray-800 transition duration-300">
                <i class="fas fa-arrow-left mr-2"></i> Volver al Listado
            </a>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="mb-4 p-4 rounded-md text-white {% if message.tags == 'success' %}bg-green-500{% elif message.tags == 'error' %}bg-red-500{% else %}bg-blue-500{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" id="atencionForm" novalidate>
            {% csrf_token %}

            <!-- Sección Paciente -->
            <div class="mb-8 p-6 border border-gray-200 rounded-lg shadow-sm bg-gray-50">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <i class="fas fa-user-injured mr-2 text-blue-500"></i> Datos del Paciente
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="{{ form.paciente_nombre.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.paciente_nombre.label }}</label>
                        {% render_field form.paciente_nombre class+="form-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %}
                        {% render_field form.paciente %} {# Campo oculto para el ID #}
                        <button type="button" id="buscarPacienteBtn" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow transition duration-150">
                            <i class="fas fa-search mr-1"></i> Buscar Paciente Existente
                        </button>
                        <button type="button" id="crearPacienteBtn" class="mt-2 ml-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow transition duration-150">
                            <i class="fas fa-user-plus mr-1"></i> Crear Nuevo Paciente
                        </button>
                    </div>
                    <div id="infoPacienteSeleccionado" class="md:col-span-2 text-sm text-gray-600">
                        {% if selected_paciente %}
                            <p><strong>Cédula:</strong> {{ selected_paciente.cedula_ecuatoriana|default:selected_paciente.dni }}</p>
                            <p><strong>Edad:</strong> {{ selected_paciente.edad }} años</p>
                            <p><strong>Teléfono:</strong> {{ selected_paciente.telefono }}</p>
                        {% else %}
                            <p class="italic">Seleccione un paciente para ver más detalles.</p>
                        {% endif %}
                    </div>
                </div>
                 {% if form.paciente_nombre.errors or form.paciente.errors %}
                    <p class="text-red-500 text-xs italic mt-1">
                        {{ form.paciente_nombre.errors|join:", " }} {{ form.paciente.errors|join:", " }}
                        {% if form.paciente_nombre.field.required and not form.paciente_nombre.value %}
                            Este campo es obligatorio.
                        {% endif %}
                    </p>
                {% endif %}
            </div>

            <!-- Sección Signos Vitales -->
            <div class="mb-8 p-6 border border-gray-200 rounded-lg shadow-sm">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center"><i class="fas fa-heartbeat mr-2 text-red-500"></i> Signos Vitales</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    {% for field in form %}
                        {% if field.name in "presion_arterial pulso temperatura frecuencia_respiratoria saturacion_oxigeno peso altura" %}
                        <div>
                            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ field.label }}</label>
                            {% render_field field class+="form-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %}
                            {% if field.help_text %}<p class="mt-1 text-xs text-gray-500">{{ field.help_text }}</p>{% endif %}
                            {% if field.errors %}<p class="text-red-500 text-xs italic mt-1">{{ field.errors|join:", " }}</p>{% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                    <div class="flex items-center mt-5">
                        {% render_field form.es_control class+="form-checkbox h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500" %}
                        <label for="{{ form.es_control.id_for_label }}" class="ml-2 block text-sm font-medium text-gray-700">{{ form.es_control.label }}</label>
                         {% if form.es_control.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.es_control.errors|join:", " }}</p>{% endif %}
                    </div>
                </div>
            </div>

            <!-- Sección Evaluación Clínica -->
            <div class="mb-8 p-6 border border-gray-200 rounded-lg shadow-sm">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center"><i class="fas fa-stethoscope mr-2 text-green-500"></i> Evaluación Clínica</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="{{ form.motivo_consulta.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.motivo_consulta.label }}</label>
                        {% render_field form.motivo_consulta class+="form-textarea block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" rows="3" %}
                        {% if form.motivo_consulta.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.motivo_consulta.errors|join:", " }}</p>{% endif %}
                    </div>
                    <div>
                        <label for="{{ form.sintomas.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.sintomas.label }}</label>
                        {% render_field form.sintomas class+="form-textarea block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" rows="3" %}
                        {% if form.sintomas.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.sintomas.errors|join:", " }}</p>{% endif %}
                    </div>
                    <div class="md:col-span-2">
                        <label for="{{ form.examen_fisico.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.examen_fisico.label }}</label>
                        {% render_field form.examen_fisico class+="form-textarea block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" rows="3" %}
                        {% if form.examen_fisico.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.examen_fisico.errors|join:", " }}</p>{% endif %}
                    </div>
                    <div class="md:col-span-2">
                        <label for="{{ form.diagnostico.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.diagnostico.label }}</label>
                        {% render_field form.diagnostico class+="select2-diagnosticos block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %}
                        {% if form.diagnostico.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.diagnostico.errors|join:", " }}</p>{% endif %}
                    </div>
                </div>
            </div>

            <!-- Sección Plan Terapéutico y Medicamentos -->
            <div class="mb-8 p-6 border border-gray-200 rounded-lg shadow-sm">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center"><i class="fas fa-pills mr-2 text-yellow-500"></i> Plan Terapéutico y Medicamentos</h2>
                <div>
                    <label for="{{ form.tratamiento.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.tratamiento.label }}</label>
                    {% render_field form.tratamiento class+="form-textarea block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" rows="3" %}
                    {% if form.tratamiento.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.tratamiento.errors|join:", " }}</p>{% endif %}
                </div>

                <h3 class="text-lg font-medium text-gray-700 mt-6 mb-3">Medicamentos Recetados</h3>
                {{ detalle_formset.management_form }}
                <div id="detalleAtencionFormset" class="space-y-6">
                    {% for detalle_form in detalle_formset %}
                    <div class="detalle-form p-4 border border-gray-200 rounded-md bg-gray-50 relative">
                        {{ detalle_form.id }} {# Campo oculto para el ID del detalle si existe #}
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
                            <div class="lg:col-span-2">
                                <label for="{{ detalle_form.medicamento_nombre.id_for_label }}" class="block text-xs font-medium text-gray-600">{{ detalle_form.medicamento_nombre.label }}</label>
                                {% render_field detalle_form.medicamento_nombre class+="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Buscar o agregar..." %}
                                {% render_field detalle_form.medicamento %} {# Campo oculto para el ID del medicamento #}
                                {% if detalle_form.medicamento_nombre.errors or detalle_form.medicamento.errors %}<p class="text-red-500 text-xs italic">{{ detalle_form.medicamento_nombre.errors|join:", " }} {{ detalle_form.medicamento.errors|join:", " }}</p>{% endif %}
                            </div>
                            <div>
                                <label for="{{ detalle_form.cantidad.id_for_label }}" class="block text-xs font-medium text-gray-600">{{ detalle_form.cantidad.label }}</label>
                                {% render_field detalle_form.cantidad class+="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %}
                                {% if detalle_form.cantidad.errors %}<p class="text-red-500 text-xs italic">{{ detalle_form.cantidad.errors|join:", " }}</p>{% endif %}
                            </div>
                            <div class="lg:col-span-3">
                                <label for="{{ detalle_form.prescripcion.id_for_label }}" class="block text-xs font-medium text-gray-600">{{ detalle_form.prescripcion.label }}</label>
                                {% render_field detalle_form.prescripcion class+="form-textarea mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" rows="1" %}
                                {% if detalle_form.prescripcion.errors %}<p class="text-red-500 text-xs italic">{{ detalle_form.prescripcion.errors|join:", " }}</p>{% endif %}
                            </div>
                             <div class="hidden"> <!-- Campos adicionales, ocultos por defecto o mostrados según necesidad -->
                                <label for="{{ detalle_form.duracion_tratamiento.id_for_label }}" class="block text-xs font-medium text-gray-600">{{ detalle_form.duracion_tratamiento.label }}</label>
                                {% render_field detalle_form.duracion_tratamiento class+="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %}

                                <label for="{{ detalle_form.frecuencia_diaria.id_for_label }}" class="block text-xs font-medium text-gray-600">{{ detalle_form.frecuencia_diaria.label }}</label>
                                {% render_field detalle_form.frecuencia_diaria class+="form-input mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" %}
                            </div>
                            <div class="flex items-center">
                                {% if detalle_formset.can_delete and detalle_form.instance.pk %}
                                <div class="mr-2">
                                    {% render_field detalle_form.DELETE class+="form-checkbox h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500" %}
                                    <label for="{{ detalle_form.DELETE.id_for_label }}" class="ml-1 text-xs text-red-700">Eliminar</label>
                                </div>
                                {% endif %}
                                {% if forloop.last %}
                                <button type="button" class="remove-form-row hidden text-red-500 hover:text-red-700 transition duration-150" title="Eliminar este medicamento">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" id="addDetalleAtencion" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow transition duration-150">
                    <i class="fas fa-plus mr-1"></i> Agregar Medicamento
                </button>
                <button type="button" id="crearNuevoMedicamentoBtn" class="mt-4 ml-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg text-sm shadow transition duration-150">
                    <i class="fas fa-capsules mr-1"></i> Crear Nuevo Medicamento
                </button>


                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label for="{{ form.examenes_enviados.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.examenes_enviados.label }}</label>
                        {% render_field form.examenes_enviados class+="form-textarea block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" rows="2" %}
                        {% if form.examenes_enviados.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.examenes_enviados.errors|join:", " }}</p>{% endif %}
                    </div>
                    <div class="relative">
                        <label for="{{ form.comentario_adicional.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">{{ form.comentario_adicional.label }}</label>
                        {% render_field form.comentario_adicional class+="form-textarea block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm pr-10" rows="2" %}
                        <button type="button" id="startVoiceComentario" title="Grabar comentario por voz" class="absolute top-7 right-2 p-2 text-gray-500 hover:text-blue-500 focus:outline-none">
                            <i class="fas fa-microphone"></i>
                        </button>
                        {% if form.comentario_adicional.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.comentario_adicional.errors|join:", " }}</p>{% endif %}
                    </div>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="mt-8 flex justify-end space-x-3">
                <button type="button" id="previsualizarBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-eye mr-2"></i> Previsualizar
                </button>
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-save mr-2"></i> {% if object %}Actualizar{% else %}Guardar{% endif %} Atención
                </button>
                <a href="{% url 'doctor:atencion_list' %}" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Modal para buscar paciente -->
{% include "fragments/modal_paciente.html" %}

<!-- Modal para Crear Nuevo Paciente -->
<div id="crearPacienteModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title-crear-paciente" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="formCrearPaciente">
                {% csrf_token %} <!-- Important for AJAX POST -->
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-user-plus text-green-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title-crear-paciente">Crear Nuevo Paciente</h3>
                            <div class="mt-4 space-y-3">
                                <!-- Simplified PatientForm fields - ideally, load this form via AJAX from a view -->
                                <div>
                                    <label for="id_Primer_nombre_modal" class="block text-sm font-medium text-gray-700">Nombres</label>
                                    <input type="text" name="Primer_nombre" id="id_Primer_nombre_modal" required class="mt-1 form-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="id_apellido_modal" class="block text-sm font-medium text-gray-700">Apellidos</label>
                                    <input type="text" name="apellido" id="id_apellido_modal" required class="mt-1 form-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="id_dni_modal" class="block text-sm font-medium text-gray-700">Cédula/DNI</label>
                                    <input type="text" name="dni" id="id_dni_modal" required class="mt-1 form-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="id_birth_date_modal" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                                    <input type="date" name="birth_date" id="id_birth_date_modal" required class="mt-1 form-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="id_gender_modal" class="block text-sm font-medium text-gray-700">Género</label>
                                    <select name="gender" id="id_gender_modal" required class="mt-1 form-select block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                                        <option value="M">Masculino</option>
                                        <option value="F">Femenino</option>
                                        <option value="O">Otro</option>
                                    </select>
                                </div>
                                <!-- Add other fields from PatientForm as needed: phone, email, address, blood_type -->
                                 <div>
                                    <label for="id_phone_modal" class="block text-sm font-medium text-gray-700">Teléfono (Opcional)</label>
                                    <input type="text" name="phone" id="id_phone_modal" class="mt-1 form-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="id_email_modal" class="block text-sm font-medium text-gray-700">Email (Opcional)</label>
                                    <input type="email" name="email" id="id_email_modal" class="mt-1 form-input block w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="guardarNuevoPacienteBtn"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Guardar Paciente
                    </button>
                    <button type="button" id="cancelarCrearPacienteBtn"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-gray-200 text-gray-900 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para previsualización -->
<div id="previsualizacionModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-file-medical-alt text-blue-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Previsualización de Atención</h3>
                        <div class="mt-2" id="previsualizacionContenido">
                            <!-- Contenido de la previsualización se cargará aquí -->
                            <p class="text-sm text-gray-500">Cargando previsualización...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="cerrarPrevisualizacionBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear nuevo medicamento -->
<div id="crearMedicamentoModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title-medicamento" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="formCrearMedicamento">
                {% csrf_token %}
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-purple-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-pills text-purple-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title-medicamento">Crear Nuevo Medicamento</h3>
                            <div class="mt-4 space-y-4">
                                <!-- Campos del formulario para nuevo medicamento -->
                                <!-- Campos del formulario para nuevo medicamento -->
                                <div>
                                    <label for="nombre_medicamento_modal" class="block text-sm font-medium text-gray-700">Nombre del Medicamento <span class="text-red-500">*</span></label>
                                    <input type="text" name="nombre_medicamento_modal" id="nombre_medicamento_modal" required class="mt-1 focus:ring-purple-500 focus:border-purple-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="tipo_medicamento_modal" class="block text-sm font-medium text-gray-700">Tipo de Medicamento <span class="text-red-500">*</span></label>
                                    <select name="tipo_medicamento_modal" id="tipo_medicamento_modal" required class="mt-1 focus:ring-purple-500 focus:border-purple-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md select2-simple">
                                        <option value="">Seleccione...</option>
                                        {% for tipo in tipos_medicamento_existentes %}
                                            <option value="{{ tipo.pk }}">{{ tipo.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="precio_modal" class="block text-sm font-medium text-gray-700">Precio <span class="text-red-500">*</span></label>
                                        <input type="number" name="precio_modal" id="precio_modal" step="0.01" min="0" value="0.00" required class="mt-1 focus:ring-purple-500 focus:border-purple-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label for="cantidad_modal" class="block text-sm font-medium text-gray-700">Stock Inicial <span class="text-red-500">*</span></label>
                                        <input type="number" name="cantidad_modal" id="cantidad_modal" min="0" value="0" required class="mt-1 focus:ring-purple-500 focus:border-purple-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                    </div>
                                </div>
                                <div>
                                    <label for="concentracion_modal" class="block text-sm font-medium text-gray-700">Concentración (Ej: 500mg)</label>
                                    <input type="text" name="concentracion_modal" id="concentracion_modal" class="mt-1 focus:ring-purple-500 focus:border-purple-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                                </div>
                                <!-- Aquí podrían ir más campos opcionales como via_administracion, marca_medicamento, etc. -->
                                <p class="text-xs text-gray-500">Los campos marcados con <span class="text-red-500">*</span> son obligatorios. Para más detalles, edite el medicamento luego desde su sección correspondiente.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="guardarNuevoMedicamentoBtn"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-purple-600 text-base font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Guardar Medicamentoa
                    </button>
                    <button type="button" id="cancelarCrearMedicamentoBtn"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-gray-200 text-gray-900 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('startVoiceComentario');
    const textarea = document.getElementById('{{ form.comentario_adicional.auto_id }}'); // Asegura que el ID coincida

    // Verificar soporte del API
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        if (btn) btn.style.display = 'none'; // Oculta botón si no es compatible
        console.warn('Este navegador no soporta Speech Recognition.');
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    const icon = btn ? btn.querySelector('i') : null;

    recognition.lang = 'es-ES';
    recognition.interimResults = true;
    recognition.continuous = false;

    let isRecognizing = false;
    let originalIconClass = icon ? icon.className : 'fas fa-microphone';
    const recordingIconClass = 'fas fa-stop-circle animate-pulse text-red-500';

    if (btn) {
        btn.addEventListener('click', function() {
            if (isRecognizing) {
                recognition.stop();
            } else {
                if (textarea) textarea.focus();
                try {
                    recognition.start();
                } catch (e) {
                    console.error("Error al iniciar reconocimiento: ", e);
                    // Podría ser que ya esté corriendo y haya entrado en un mal estado.
                    // Intentar abortar y limpiar.
                    try { recognition.abort(); } catch (abortError) {}
                    isRecognizing = false;
                    if (icon) icon.className = originalIconClass;
                     alert("No se pudo iniciar el reconocimiento de voz. Verifique los permisos del micrófono y que no haya otra instancia activa.");
                }
            }
        });
    }

    recognition.onstart = function() {
        isRecognizing = true;
        if (icon) {
            icon.className = recordingIconClass;
        }
        btn.title = "Detener grabación";
        console.log('Grabación iniciada...');
    };

    recognition.onerror = function(event) {
        console.error('Error en reconocimiento:', event.error);
        let userMessage = 'Error en el reconocimiento de voz.';
        if (event.error === 'no-speech') {
            userMessage = 'No se detectó voz. Inténtelo de nuevo.';
            console.warn('No se detectó voz.');
        } else if (event.error === 'audio-capture') {
            userMessage = 'Problema con el micrófono. Asegúrese de que está conectado y funcionando.';
            console.warn('Problema con el micrófono.');
        } else if (event.error === 'not-allowed') {
            userMessage = 'Permiso para micrófono denegado. Por favor, habilite el acceso al micrófono en la configuración de su navegador.';
            console.warn('Permiso para micrófono denegado.');
        } else if (event.error === 'network') {
            userMessage = 'Error de red durante el reconocimiento de voz. Verifique su conexión a internet.';
            console.warn('Error de red.');
        } else if (event.error === 'aborted') {
            // Esto puede pasar si se llama a recognition.stop() o recognition.abort()
            // No necesariamente un error que mostrar al usuario si fue intencional.
            console.log('Reconocimiento abortado.');
            userMessage = ''; // No mostrar mensaje si fue abortado programáticamente.
        }

        if (userMessage && event.error !== 'aborted') { // No mostrar alerta si fue abortado (ej. por click en stop)
            // Considerar mostrar esto en un elemento no-bloqueante en lugar de alert.
            // alert(userMessage);
            console.warn("Mensaje para el usuario (no mostrado vía alert): " + userMessage);
        }
        // onend se encargará de resetear el estado de isRecognizing y el icono.
    };

    recognition.onend = function() {
        isRecognizing = false;
        if (icon) {
            icon.className = originalIconClass;
        }
        if (btn) btn.title = "Grabar comentario por voz";
        console.log('Reconocimiento finalizado.');
    };

    recognition.onresult = function(event) {
        let final_transcript = '';
        let interim_transcript = '';

        for (let i = event.resultIndex; i < event.results.length; ++i) {
            const transcript_piece = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                final_transcript += transcript_piece;
            } else {
                interim_transcript += transcript_piece;
            }
        }

        if (textarea) {
            if (final_transcript) {
                const currentText = textarea.value;
                // Añadir un espacio si el textarea no está vacío y no termina ya con un espacio.
                const prefix = (currentText.length > 0 && currentText.slice(-1) !== ' ') ? ' ' : '';
                textarea.value += prefix + final_transcript.trim() + ' '; // Añade la transcripción y un espacio.
            }
        }
        // Para depuración:
        // console.log('Interim: ', interim_transcript);
        // console.log('Final: ', final_transcript);
    };

    // --- Crear Nuevo Paciente Modal Logic ---
    const crearPacienteBtn = document.getElementById('crearPacienteBtn');
    const crearPacienteModal = document.getElementById('crearPacienteModal');
    const cancelarCrearPacienteBtn = document.getElementById('cancelarCrearPacienteBtn');
    const guardarNuevoPacienteBtn = document.getElementById('guardarNuevoPacienteBtn');
    const formCrearPaciente = document.getElementById('formCrearPaciente');

    if (crearPacienteBtn && crearPacienteModal && cancelarCrearPacienteBtn && guardarNuevoPacienteBtn && formCrearPaciente) {
        crearPacienteBtn.addEventListener('click', () => {
            formCrearPaciente.reset(); // Reset form fields
            // Clear previous errors if any
            const errorMessages = crearPacienteModal.querySelectorAll('.form-error-message');
            errorMessages.forEach(msg => msg.remove());
            crearPacienteModal.classList.remove('hidden');
        });

        cancelarCrearPacienteBtn.addEventListener('click', () => {
            crearPacienteModal.classList.add('hidden');
        });

        guardarNuevoPacienteBtn.addEventListener('click', () => {
            const formData = new FormData(formCrearPaciente);
            const submitButton = guardarNuevoPacienteBtn;
            const originalButtonText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
            submitButton.disabled = true;

            // Clear previous errors
            const errorMessages = crearPacienteModal.querySelectorAll('.form-error-message');
            errorMessages.forEach(msg => msg.remove());

            fetch("{% url 'doctor:ajax_create_patient' %}", { // Assumes this URL name exists
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    messages.success('Paciente creado con éxito: ' + data.paciente.Primer_nombre + ' ' + data.paciente.apellido);
                    crearPacienteModal.classList.add('hidden');

                    // Update main form's patient fields
                    document.getElementById('{{ form.paciente_nombre.id_for_label }}').value = data.paciente.Primer_nombre + ' ' + data.paciente.apellido;
                    document.getElementById('{{ form.paciente.id_for_label }}').value = data.paciente.id;

                    // Update infoPacienteSeleccionado div
                    const infoDiv = document.getElementById('infoPacienteSeleccionado');
                    if (infoDiv) {
                        infoDiv.innerHTML = `
                            <p><strong>Cédula:</strong> ${data.paciente.dni || 'N/A'}</p>
                            <p><strong>Edad:</strong> ${data.paciente.edad || 'N/A'} años</p> {# Assuming 'edad' is returned #}
                            <p><strong>Teléfono:</strong> ${data.paciente.phone || 'N/A'}</p>
                        `;
                        // Trigger a change event if other scripts depend on it
                        const pacienteNombreInput = document.getElementById('{{ form.paciente_nombre.id_for_label }}');
                        if(pacienteNombreInput) pacienteNombreInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                     // SweetAlert2 success message
                    Swal.fire({
                        icon: 'success',
                        title: '¡Paciente Creado!',
                        text: `El paciente ${data.paciente.Primer_nombre} ${data.paciente.apellido} ha sido creado y seleccionado.`,
                        timer: 2500,
                        showConfirmButton: false
                    });


                } else if (data.status === 'error') {
                    console.error('Error al crear paciente:', data.errors);
                    if (typeof data.errors === 'object' && data.errors !== null) {
                        Object.keys(data.errors).forEach(field => {
                            const inputField = formCrearPaciente.querySelector(`[name="${field}"]`);
                            const errorList = data.errors[field];
                            if (inputField && errorList.length > 0) {
                                let errorDiv = inputField.parentElement.querySelector('.form-error-message');
                                if (!errorDiv) {
                                    errorDiv = document.createElement('p');
                                    errorDiv.className = 'text-red-500 text-xs italic mt-1 form-error-message';
                                    inputField.parentElement.appendChild(errorDiv);
                                }
                                errorDiv.textContent = errorList.map(e => e.message || e).join(' ');
                            }
                        });
                         Swal.fire({
                            icon: 'error',
                            title: 'Error al Crear Paciente',
                            html: "Por favor, corrija los errores en el formulario.<br><pre class='text-left text-sm'>" + JSON.stringify(data.errors, null, 2) + "</pre>",
                        });
                    } else {
                         Swal.fire({
                            icon: 'error',
                            title: 'Error Inesperado',
                            text: data.errors || 'Ocurrió un error al crear el paciente.',
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Conexión',
                    text: 'No se pudo conectar con el servidor. Intente de nuevo.',
                });
            })
            .finally(() => {
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
            });
        });
    }
    // --- End Crear Nuevo Paciente Modal Logic ---

    // --- Crear Nuevo Medicamento Modal Logic ---
    const crearMedicamentoBtn = document.getElementById('crearNuevoMedicamentoBtn');
    const crearMedicamentoModal = document.getElementById('crearMedicamentoModal');
    const cancelarCrearMedicamentoBtn = document.getElementById('cancelarCrearMedicamentoBtn');
    const guardarNuevoMedicamentoBtn = document.getElementById('guardarNuevoMedicamentoBtn');
    const formCrearMedicamento = document.getElementById('formCrearMedicamento');
    // const selectTipoMedicamentoModal = $('#tipo_medicamento_modal'); // Initialize with Select2 if used

    if (crearMedicamentoBtn && crearMedicamentoModal && cancelarCrearMedicamentoBtn && guardarNuevoMedicamentoBtn && formCrearMedicamento) {
        crearMedicamentoBtn.addEventListener('click', () => {
            formCrearMedicamento.reset();
            // if (selectTipoMedicamentoModal.data('select2')) { // Reset Select2 if initialized
            //     selectTipoMedicamentoModal.val(null).trigger('change');
            // }
            const errorMessages = crearMedicamentoModal.querySelectorAll('.form-error-message');
            errorMessages.forEach(msg => msg.remove());
            crearMedicamentoModal.classList.remove('hidden');
        });

        cancelarCrearMedicamentoBtn.addEventListener('click', () => {
            crearMedicamentoModal.classList.add('hidden');
        });

        guardarNuevoMedicamentoBtn.addEventListener('click', () => {
            const formData = new FormData(formCrearMedicamento);
            const submitButton = guardarNuevoMedicamentoBtn;
            const originalButtonText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
            submitButton.disabled = true;

            const errorMessages = crearMedicamentoModal.querySelectorAll('.form-error-message');
            errorMessages.forEach(msg => msg.remove());

            fetch("{% url 'doctor:ajax_create_medicamento' %}", { // Assumes 'doctor:ajax_create_medicamento'
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    crearMedicamentoModal.classList.add('hidden');
                    Swal.fire({
                        icon: 'success',
                        title: '¡Medicamento Creado!',
                        html: `El medicamento <strong>${data.medicamento_nombre}</strong> (ID: ${data.medicamento_id}) ha sido creado.<br>Ya puede buscarlo y seleccionarlo en la receta.`,
                        confirmButtonText: 'Entendido'
                    });
                    // Optional: Add to the <select> or trigger a refresh of an autocomplete source
                    // For now, user will have to search for it.
                    // If a specific formset row input triggered this, you might try to populate it:
                    // E.g., if you stored a reference to the input:
                    // if (window.activeMedicamentoInput) {
                    //    window.activeMedicamentoInput.value = data.medicamento_text; // or data.medicamento_nombre
                    //    const idField = window.activeMedicamentoInput.closest('.detalle-form').querySelector('input[name$="-medicamento"]');
                    //    if (idField) idField.value = data.medicamento_id;
                    //    window.activeMedicamentoInput = null; // Clear reference
                    // }

                } else if (data.status === 'error') {
                    console.error('Error al crear medicamento:', data.message, data.errors);
                    let errorTitle = 'Error al Crear Medicamento';
                    let errorMessageHtml = '';

                    if (data.message) {
                        errorMessageHtml += `<p>${data.message}</p>`;
                    } else {
                        errorMessageHtml += "<p>Por favor, corrija los errores en el formulario.</p>";
                    }

                    let fieldErrors = data.errors;
                    if (typeof data.errors === 'string') {
                        try {
                            fieldErrors = JSON.parse(data.errors); // For errors from form.errors.as_json()
                        } catch (e) {
                            console.warn("Could not parse errors string:", data.errors);
                            errorMessageHtml += `<p class="mt-2">Detalles del error: ${data.errors}</p>`;
                            fieldErrors = null; // Prevent further processing if parsing failed
                        }
                    }

                    if (typeof fieldErrors === 'object' && fieldErrors !== null) {
                        errorMessageHtml += "<ul class='list-disc list-inside text-left text-sm mt-2'>";
                        Object.keys(fieldErrors).forEach(field => {
                            // The field name in errors might be 'nombre' but in form is 'nombre_medicamento_modal'
                            // Need to find the corresponding input. The view's field_map is backend-side.
                            // For simplicity, we'll just list errors, attaching to fields can be tricky with name mismatches.
                            // Or, ensure modal names directly match form field names used in MedicamentoForm.
                            // Assuming modal names are like 'nombre_medicamento_modal', etc.
                            // And form field names are 'nombre', 'tipo', etc.
                            // The current backend already maps them.
                            const inputFieldKey = Object.keys(formCrearMedicamento.elements).find(key => {
                                const el = formCrearMedicamento.elements[key];
                                // Check if element name (e.g. "nombre_medicamento_modal") contains the error field key (e.g. "nombre")
                                return el.name && el.name.includes(field);
                            });
                            const inputField = inputFieldKey ? formCrearMedicamento.elements[inputFieldKey] : null;

                            const errorList = fieldErrors[field]; // This is usually a list of error objects/strings
                            errorList.forEach(errObj => {
                                const message = (typeof errObj === 'string') ? errObj : (errObj.message || JSON.stringify(errObj));
                                errorMessageHtml += `<li><strong>${field}</strong>: ${message}</li>`;
                                if (inputField && inputField.parentElement) {
                                    let errorDiv = inputField.parentElement.querySelector('.form-error-message');
                                    if (!errorDiv) {
                                        errorDiv = document.createElement('p');
                                        errorDiv.className = 'text-red-500 text-xs italic mt-1 form-error-message';
                                        // Insert after the input field
                                        inputField.parentElement.insertBefore(errorDiv, inputField.nextSibling);
                                    }
                                    errorDiv.textContent = message; // Display first error for the field
                                }
                            });
                        });
                        errorMessageHtml += "</ul>";
                    } else if (data.errors && typeof data.errors === 'string' && !fieldErrors) { // If parsing failed but original string exists
                         // Handled by initial errorMessageHtml if parsing failed
                    }


                    if (!errorMessageHtml && !data.message && !data.errors) {
                         errorMessageHtml = 'Ocurrió un error inesperado al crear el medicamento.';
                    }

                    Swal.fire({
                        icon: 'error',
                        title: errorTitle,
                        html: errorMessageHtml,
                    });

                } else if (data.message && !data.status) { // Catch-all for other error structures
                     Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message
                    });
                } else { // Fallback for completely unexpected structure
                     Swal.fire({
                            icon: 'error',
                            title: 'Error Inesperado',
                            text: 'Ocurrió un error al crear el medicamento.'
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                 Swal.fire({
                    icon: 'error',
                    title: 'Error de Conexión',
                    text: 'No se pudo conectar con el servidor. Intente de nuevo.',
                });
            })
            .finally(() => {
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
            });
        });
    }
    // --- End Crear Nuevo Medicamento Modal Logic ---
});
</script>
{% endblock js %}

