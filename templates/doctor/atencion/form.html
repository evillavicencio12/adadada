{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}
{% load i18n %}

{% block title %}
    {% if object %}{% translate "Editar Atención Médica" %} #{{object.id}}{% else %}{% translate "Nueva Atención Médica" %}{% endif %}
{% endblock %}

{% block extrastyles %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{# Considerar un tema de Select2 compatible con el tema general (Bootstrap 5 si es el caso) #}
{# <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" /> #}
<style>
    .form-section {
        @apply mb-10 p-6 border border-gray-200 rounded-xl shadow-lg; /* Sombra más pronunciada y bordes redondeados */
    }
    .form-section-title {
        @apply text-xl font-semibold text-gray-800 mb-6 flex items-center pb-3 border-b-2 border-indigo-200;
    }
    .form-section-title i {
        @apply mr-3 text-xl text-indigo-600;
    }
    .form-label {
        @apply block text-sm font-medium text-gray-700 mb-1.5; /* Más margen inferior */
    }
    .form-input-tailwind,
    .form-textarea-tailwind,
    .form-select-tailwind,
    select[class*="select2"] { /* Aplicar a Select2 también */
        @apply mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-600 sm:text-sm py-2.5 px-3.5;
        /* Bordes más gruesos en foco, padding ajustado */
    }
    .form-textarea-tailwind {
        min-height: 80px; /* Altura mínima para textareas */
    }
    .form-checkbox-tailwind {
        @apply h-5 w-5 text-indigo-600 border-gray-300 rounded-md focus:ring-indigo-500 focus:ring-offset-1; /* Offset en foco */
    }

    /* Estilos para Select2 (genéricos, ajustar si se usa un tema específico) */
    .select2-container--default .select2-selection--single,
    .select2-container--default .select2-selection--multiple {
        @apply border-gray-300 rounded-lg shadow-sm;
        min-height: calc(1.5em + .75rem + 8px); /* Alineación altura con otros inputs */
        padding-top: 0.1rem;
        padding-bottom: 0.1rem;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        @apply leading-tight pt-1.5;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        @apply bg-indigo-100 text-indigo-700 border-indigo-200;
    }

    .btn-primary-custom {
        @apply bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-5 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out flex items-center justify-center;
    }
    .btn-secondary-custom {
        @apply bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2.5 px-5 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out flex items-center justify-center;
    }
     .btn-danger-custom { /* Para botones de eliminar */
        @apply bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out flex items-center justify-center;
    }
    .btn-info-custom { /* Para botones como "Agregar Medicamento" */
        @apply bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 rounded-lg shadow-sm hover:shadow-md transition duration-150 ease-in-out flex items-center justify-center text-sm;
    }

    .detalle-form {
        @apply p-5 border border-gray-200 rounded-lg bg-slate-50 relative; /* Ligeramente más padding y color de fondo */
        transition: box-shadow 0.2s ease-in-out;
    }
    .detalle-form:hover {
        @apply shadow-lg; /* Sombra más notable al hacer hover */
    }
    #infoPacienteSeleccionado {
        @apply md:col-span-2 text-sm text-gray-700 p-4 bg-indigo-50 rounded-xl border-2 border-indigo-100; /* Más padding y borde */
    }
    #infoPacienteSeleccionado strong {
        @apply font-semibold text-indigo-800;
    }
    .modal-content-custom { /* Para los modales */
        @apply bg-white rounded-xl shadow-xl overflow-hidden;
    }
    .modal-header-custom {
        @apply px-6 py-4 bg-gray-50 border-b border-gray-200;
    }
    .modal-body-custom {
        @apply p-6 space-y-4;
    }
    .modal-footer-custom {
        @apply px-6 py-4 bg-gray-50 text-right space-x-2;
    }
</style>
{% endblock %}


{% block content %}
<div class="container mx-auto px-2 sm:px-4 py-8">
    <div class="bg-white shadow-2xl rounded-xl p-4 sm:p-6 md:p-10">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 pb-4 border-b border-gray-300">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
                    <i class="fas fa-notes-medical mr-3 text-indigo-600"></i>
                    {% if object %}{% translate "Editar Atención Médica" %} #{{object.id}}{% else %}{% translate "Nueva Atención Médica" %}{% endif %}
                </h1>
                <p class="text-sm text-gray-500 mt-1">{% translate "Complete los detalles de la consulta médica." %}</p>
            </div>
            <a href="{% url 'doctor:atencion_list' %}" class="mt-3 sm:mt-0 inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition duration-150">
                <i class="fas fa-arrow-left mr-2"></i> {% translate "Volver al Listado" %}
            </a>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="mb-6 p-4 rounded-lg text-sm {% if message.tags == 'success' %}bg-green-100 border border-green-300 text-green-800{% elif message.tags == 'error' %}bg-red-100 border border-red-300 text-red-800{% else %}bg-blue-100 border border-blue-300 text-blue-800{% endif %} shadow">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" id="atencionForm" novalidate>
            {% csrf_token %}

            <!-- Sección Paciente -->
            <div class="form-section bg-slate-50">
                <h2 class="form-section-title">
                    <i class="fas fa-user-injured text-indigo-500"></i> {% translate "Datos del Paciente" %}
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 items-start">
                    <div class="md:col-span-1">
                        <label for="{{ form.paciente_nombre.id_for_label }}" class="form-label">{{ form.paciente_nombre.label }}</label>
                        {% render_field form.paciente_nombre id="paciente_nombre_display" class+="form-input-tailwind" placeholder="Buscar paciente..." data_initial_text=form.paciente_nombre.value|default:'' %}
                        <div class="hidden"> {{ form.paciente }} </div>
                        {% if form.paciente_nombre.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.paciente_nombre.errors|join:", " }}</p>{% endif %}
                        {% if form.paciente.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.paciente.errors|join:", " }}</p>{% endif %}
                        <div class="mt-2">
                             <button type="button" id="abrirCrearPacienteBtn" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium transition duration-150">
                                <i class="fas fa-user-plus mr-1"></i> {% translate "Crear Nuevo Paciente" %}
                            </button>
                        </div>
                    </div>
                    <div id="infoPacienteSeleccionado">
                        {% if selected_paciente %}
                            <h4 class="font-semibold text-indigo-700 mb-2 text-sm">{% translate "Info. del Paciente:" %}</h4>
                            <p><strong>{% translate "Nombre:" %}</strong> {{ selected_paciente.primer_nombre }} {{ selected_paciente.apellido }}</p>
                            <p><strong>{% translate "DNI:" %}</strong> {{ selected_paciente.dni }}</p>
                            <p><strong>{% translate "Edad:" %}</strong> {{ selected_paciente.edad_calculada|default:"N/A" }} {% translate "años" %}</p>
                            <p><strong>{% translate "Teléfono:" %}</strong> {{ selected_paciente.phone|default:"N/A" }}</p>
                        {% elif form.instance.pk and form.instance.paciente %}
                            <h4 class="font-semibold text-indigo-700 mb-2 text-sm">{% translate "Info. del Paciente:" %}</h4>
                            <p><strong>{% translate "Nombre:" %}</strong> {{ form.instance.paciente.primer_nombre }} {{ form.instance.paciente.apellido }}</p>
                            <p><strong>{% translate "DNI:" %}</strong> {{ form.instance.paciente.dni }}</p>
                            <p><strong>{% translate "Edad:" %}</strong> {{ form.instance.paciente.edad_calculada|default:"N/A" }} {% translate "años" %}</p>
                            <p><strong>{% translate "Teléfono:" %}</strong> {{ form.instance.paciente.phone|default:"N/A" }}</p>
                        {% else %}
                            <p class="italic text-gray-500 py-4">{% translate "Seleccione un paciente para ver sus detalles aquí." %}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sección Signos Vitales -->
            <div class="form-section">
                <h2 class="form-section-title"><i class="fas fa-heartbeat text-red-500"></i> {% translate "Signos Vitales" %}</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-6 gap-y-4 items-end">
                    {% for field_name in "presion_arterial pulso temperatura frecuencia_respiratoria saturacion_oxigeno peso altura"|split:" " %}
                        {% with field=form|getattr:field_name %}
                            <div>
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                {% render_field field class+="form-input-tailwind" %}
                                {% if field.help_text %}<p class="mt-1 text-xs text-gray-500">{{ field.help_text }}</p>{% endif %}
                                {% if field.errors %}<p class="text-red-500 text-xs italic mt-1">{{ field.errors|join:", " }}</p>{% endif %}
                            </div>
                        {% endwith %}
                    {% endfor %}
                    <div class="col-span-full sm:col-span-1 flex items-center mt-2 sm:mt-4">
                        <label for="{{ form.es_control.id_for_label }}" class="form-label flex items-center cursor-pointer">
                            {% render_field form.es_control class+="form-checkbox-tailwind" %}
                            <span class="ml-2">{{ form.es_control.label }}</span>
                        </label>
                         {% if form.es_control.errors %}<p class="text-red-500 text-xs italic ml-2">{{ form.es_control.errors|join:", " }}</p>{% endif %}
                    </div>
                </div>
            </div>

            <!-- Sección Evaluación Clínica -->
            <div class="form-section">
                <h2 class="form-section-title"><i class="fas fa-stethoscope text-green-500"></i> {% translate "Evaluación Clínica" %}</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="{{ form.motivo_consulta.id_for_label }}" class="form-label">{{ form.motivo_consulta.label }}</label>
                        {% render_field form.motivo_consulta class+="form-textarea-tailwind" rows="3" %}
                        {% if form.motivo_consulta.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.motivo_consulta.errors|join:", " }}</p>{% endif %}
                    </div>
                    <div>
                        <label for="{{ form.sintomas.id_for_label }}" class="form-label">{{ form.sintomas.label }}</label>
                        {% render_field form.sintomas class+="form-textarea-tailwind" rows="3" %}
                        {% if form.sintomas.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.sintomas.errors|join:", " }}</p>{% endif %}
                    </div>
                    <div class="md:col-span-2">
                        <label for="{{ form.examen_fisico.id_for_label }}" class="form-label">{{ form.examen_fisico.label }}</label>
                        {% render_field form.examen_fisico class+="form-textarea-tailwind" rows="3" %}
                        {% if form.examen_fisico.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.examen_fisico.errors|join:", " }}</p>{% endif %}
                    </div>
                    <div class="md:col-span-2">
                        <label for="{{ form.diagnostico.id_for_label }}" class="form-label">{{ form.diagnostico.label }}</label>
                        {% render_field form.diagnostico class+="select2-diagnosticos form-input-tailwind" %}
                        {% if form.diagnostico.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.diagnostico.errors|join:", " }}</p>{% endif %}
                    </div>
                </div>
            </div>

            <!-- Sección Plan Terapéutico y Medicamentos -->
            <div class="form-section">
                <h2 class="form-section-title"><i class="fas fa-pills text-yellow-500"></i> {% translate "Plan Terapéutico y Medicamentos" %}</h2>
                <div class="mb-6">
                    <label for="{{ form.tratamiento.id_for_label }}" class="form-label">{{ form.tratamiento.label }}</label>
                    {% render_field form.tratamiento class+="form-textarea-tailwind" rows="3" %}
                    {% if form.tratamiento.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.tratamiento.errors|join:", " }}</p>{% endif %}
                </div>

                <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-4 pb-2 border-b border-gray-200">{% translate "Medicamentos Recetados" %}</h3>
                {{ detalle_formset.management_form }}

                <div id="detalleAtencionFormset" class="space-y-4">
                    {% for detalle_form in detalle_formset.forms %}
                    <div class="detalle-form" data-prefix="{{ detalle_form.prefix }}">
                        {{ detalle_form.id }}
                        {% if detalle_form.instance.pk and detalle_formset.can_delete %}
                            <div class="absolute top-3 right-3">
                                {% render_field detalle_form.DELETE class+="form-checkbox-tailwind" %}
                                <label for="{{ detalle_form.DELETE.id_for_label }}" class="ml-1 text-xs text-red-700 hover:text-red-800">{% translate "Eliminar" %}</label>
                            </div>
                        {% endif %}
                        <div class="grid grid-cols-1 md:grid-cols-6 lg:grid-cols-12 gap-x-4 gap-y-3 items-start">
                            <div class="lg:col-span-4 md:col-span-6">
                                <label for="id_{{ detalle_form.prefix }}-medicamento_select_display" class="form-label text-xs">{% translate "Medicamento" %}</label>
                                <select id="id_{{ detalle_form.prefix }}-medicamento_select_display" name="{{ detalle_form.prefix }}-medicamento_select_display" class="medicamento-select2 form-input-tailwind" style="width: 100%;"></select>
                                <div class="hidden">{{ detalle_form.medicamento }}</div>
                                {% if detalle_form.medicamento.errors %}<p class="text-red-500 text-xs italic mt-1">{{ detalle_form.medicamento.errors|join:", " }}</p>{% endif %}
                            </div>
                            <div class="lg:col-span-2 md:col-span-2">
                                <label for="{{ detalle_form.cantidad.id_for_label }}" class="form-label text-xs">{{ detalle_form.cantidad.label }}</label>
                                {% render_field detalle_form.cantidad class+="form-input-tailwind" %}
                                {% if detalle_form.cantidad.errors %}<p class="text-red-500 text-xs italic mt-1">{{ detalle_form.cantidad.errors|join:", " }}</p>{% endif %}
                            </div>
                            <div class="lg:col-span-4 md:col-span-4">
                                <label for="{{ detalle_form.prescripcion.id_for_label }}" class="form-label text-xs">{{ detalle_form.prescripcion.label }}</label>
                                {% render_field detalle_form.prescripcion class+="form-textarea-tailwind" rows="1" %}
                                {% if detalle_form.prescripcion.errors %}<p class="text-red-500 text-xs italic mt-1">{{ detalle_form.prescripcion.errors|join:", " }}</p>{% endif %}
                            </div>
                            <div class="hidden">
                                {% render_field detalle_form.duracion_tratamiento %}
                                {% render_field detalle_form.frecuencia_diaria %}
                            </div>
                            <div class="lg:col-span-2 md:col-span-full flex items-start justify-end pt-4 md:pt-5">
                                {% if not detalle_form.instance.pk and detalle_formset.can_delete_extra %}
                                <button type="button" class="remove-form-row-dynamic text-red-500 hover:text-red-700 transition duration-150" title="{% translate 'Eliminar este medicamento' %}">
                                    <i class="fas fa-minus-circle"></i> <span class="ml-1 text-xs">{% translate "Quitar" %}</span>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <template id="detalleAtencionTemplate">
                    <div class="detalle-form" data-prefix="__prefix__">
                        <div class="grid grid-cols-1 md:grid-cols-6 lg:grid-cols-12 gap-x-4 gap-y-3 items-start">
                            <div class="lg:col-span-4 md:col-span-6">
                                <label for="id_detalles-__prefix__-medicamento_select_display" class="form-label text-xs">{% translate "Medicamento" %}</label>
                                <select id="id_detalles-__prefix__-medicamento_select_display" name="detalles-__prefix__-medicamento_select_display" class="medicamento-select2 form-input-tailwind" style="width: 100%;"></select>
                                <div class="hidden"><input type="hidden" name="detalles-__prefix__-medicamento" id="id_detalles-__prefix__-medicamento"></div>
                            </div>
                            <div class="lg:col-span-2 md:col-span-2">
                                <label for="id_detalles-__prefix__-cantidad" class="form-label text-xs">{% translate "Cantidad" %}</label>
                                <input type="number" name="detalles-__prefix__-cantidad" class="form-input-tailwind" min="1" id="id_detalles-__prefix__-cantidad">
                            </div>
                            <div class="lg:col-span-4 md:col-span-4">
                                <label for="id_detalles-__prefix__-prescripcion" class="form-label text-xs">{% translate "Prescripción" %}</label>
                                <textarea name="detalles-__prefix__-prescripcion" class="form-textarea-tailwind" rows="1" id="id_detalles-__prefix__-prescripcion"></textarea>
                            </div>
                            <div class="hidden">
                                <input type="hidden" name="detalles-__prefix__-id" id="id_detalles-__prefix__-id">
                                <input type="checkbox" name="detalles-__prefix__-DELETE" id="id_detalles-__prefix__-DELETE" class="hidden">
                                <input type="number" name="detalles-__prefix__-duracion_tratamiento" id="id_detalles-__prefix__-duracion_tratamiento">
                                <input type="number" name="detalles-__prefix__-frecuencia_diaria" id="id_detalles-__prefix__-frecuencia_diaria">
                            </div>
                            <div class="lg:col-span-2 md:col-span-full flex items-start justify-end pt-4 md:pt-5">
                                <button type="button" class="remove-form-row-dynamic text-red-500 hover:text-red-700 transition duration-150" title="{% translate 'Eliminar este medicamento' %}">
                                     <i class="fas fa-minus-circle"></i> <span class="ml-1 text-xs">{% translate "Quitar" %}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="mt-4 flex flex-wrap gap-2">
                    <button type="button" id="addDetalleAtencion" class="btn-info-custom">
                        <i class="fas fa-plus mr-2"></i> {% translate "Agregar Medicamento" %}
                    </button>
                    <button type="button" id="crearNuevoMedicamentoBtn" class="btn-primary-custom">
                        <i class="fas fa-capsules mr-2"></i> {% translate "Crear Nuevo Medicamento (Catálogo)" %}
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mt-6">
                    <div>
                        <label for="{{ form.examenes_enviados.id_for_label }}" class="form-label">{{ form.examenes_enviados.label }}</label>
                        {% render_field form.examenes_enviados class+="form-textarea-tailwind" rows="2" %}
                        {% if form.examenes_enviados.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.examenes_enviados.errors|join:", " }}</p>{% endif %}
                    </div>
                    <div class="relative">
                        <label for="{{ form.comentario_adicional.id_for_label }}" class="form-label">{{ form.comentario_adicional.label }}</label>
                        {% render_field form.comentario_adicional class+="form-textarea-tailwind pr-10" rows="2" %}
                        <button type="button" id="startVoiceComentario" title="{% translate 'Grabar comentario por voz' %}" class="absolute top-9 right-3 text-gray-500 hover:text-indigo-500 focus:outline-none"> {# Ajustada posición del botón #}
                            <i class="fas fa-microphone"></i>
                        </button>
                        {% if form.comentario_adicional.errors %}<p class="text-red-500 text-xs italic mt-1">{{ form.comentario_adicional.errors|join:", " }}</p>{% endif %}
                    </div>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="mt-10 pt-6 border-t border-gray-300 flex justify-end space-x-3">
                <a href="{% url 'doctor:atencion_list' %}" class="btn-secondary-custom">
                    <i class="fas fa-times mr-2"></i> {% translate "Cancelar" %}
                </a>
                <button type="submit" class="btn-primary-custom">
                    <i class="fas fa-save mr-2"></i> {% if object %}{% translate "Actualizar Atención" %}{% else %}{% translate "Guardar Atención" %}{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Crear Nuevo Paciente -->
<div id="crearPacienteModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 flex justify-center items-center z-50 p-4 transition-opacity duration-300 ease-in-out">
  <div class="modal-content-custom w-full max-w-lg">
    <div class="modal-header-custom flex justify-between items-center">
      <h3 class="text-lg font-semibold text-gray-800" id="modal-title-crear-paciente">{% translate "Crear Nuevo Paciente" %}</h3>
      <button type="button" id="closeCrearPacienteModal" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times fa-lg"></i>
      </button>
    </div>
    <form id="formCrearPaciente" novalidate class="modal-body-custom">
        {% csrf_token %} {# Para el fetch POST #}
        {# Campos del formulario de paciente aquí, con clases form-label y form-input-tailwind #}
        <div>
          <label for="id_primer_nombre_modal" class="form-label">{% translate "Nombres" %}<span class="text-red-500">*</span></label>
          <input type="text" name="primer_nombre" id="id_primer_nombre_modal" required class="form-input-tailwind">
        </div>
        <div>
          <label for="id_apellido_modal" class="form-label">{% translate "Apellidos" %}<span class="text-red-500">*</span></label>
          <input type="text" name="apellido" id="id_apellido_modal" required class="form-input-tailwind">
        </div>
        <div>
          <label for="id_dni_modal" class="form-label">{% translate "Cédula/DNI" %}<span class="text-red-500">*</span></label>
          <input type="text" name="dni" id="id_dni_modal" required class="form-input-tailwind">
        </div>
        <div>
          <label for="id_birth_date_modal" class="form-label">{% translate "Fecha de Nacimiento" %}<span class="text-red-500">*</span></label>
          <input type="date" name="birth_date" id="id_birth_date_modal" required class="form-input-tailwind">
        </div>
        <div>
          <label for="id_gender_modal" class="form-label">{% translate "Género" %}<span class="text-red-500">*</span></label>
          <select name="gender" id="id_gender_modal" required class="form-select-tailwind">
            <option value="M">{% translate "Masculino" %}</option>
            <option value="F">{% translate "Femenino" %}</option>
            <option value="O">{% translate "Otro" %}</option>
          </select>
        </div>
        <div>
          <label for="id_phone_modal" class="form-label">{% translate "Teléfono (Opcional)" %}</label>
          <input type="text" name="phone" id="id_phone_modal" class="form-input-tailwind">
        </div>
        <div>
          <label for="id_email_modal" class="form-label">{% translate "Email (Opcional)" %}</label>
          <input type="email" name="email" id="id_email_modal" class="form-input-tailwind">
        </div>
    </form>
    <div class="modal-footer-custom">
        <button type="button" id="cancelarCrearPacienteBtn" class="btn-secondary-custom text-sm py-2 px-4">{% translate "Cancelar" %}</button>
        <button type="submit" form="formCrearPaciente" id="guardarNuevoPacienteBtn" class="btn-primary-custom text-sm py-2 px-4">{% translate "Guardar Paciente" %}</button>
    </div>
  </div>
</div>

<!-- Modal para Previsualización -->
<div id="previsualizacionModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 flex justify-center items-center z-50 p-4 transition-opacity duration-300 ease-in-out">
    <div class="modal-content-custom w-full max-w-xl">
        <div class="modal-header-custom flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800" id="modal-title-previsualizacion">{% translate "Previsualización de Atención" %}</h3>
            <button type="button" id="closePrevisualizacionModal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <div class="modal-body-custom max-h-[70vh] overflow-y-auto">
            <div id="previsualizacionContenido">
                <p class="text-sm text-gray-500 italic">{% translate "Cargando previsualización..." %}</p>
            </div>
        </div>
        <div class="modal-footer-custom">
            <button type="button" id="cerrarPrevisualizacionBtn" class="btn-secondary-custom text-sm py-2 px-4">{% translate "Cerrar" %}</button>
        </div>
    </div>
</div>

<!-- Modal para Crear Nuevo Medicamento -->
<div id="crearMedicamentoModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-60 flex justify-center items-center z-50 p-4 transition-opacity duration-300 ease-in-out">
  <div class="modal-content-custom w-full max-w-lg">
    <div class="modal-header-custom flex justify-between items-center">
      <h3 class="text-lg font-semibold text-gray-800" id="modal-title-crear-medicamento">{% translate "Crear Nuevo Medicamento" %}</h3>
       <button type="button" id="closeCrearMedicamentoModal" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-lg"></i></button>
    </div>
    <form id="formCrearMedicamento" novalidate class="modal-body-custom">
        {% csrf_token %}
        <div>
          <label for="nombre_medicamento_modal" class="form-label">{% translate "Nombre del Medicamento" %} <span class="text-red-500">*</span></label>
          <input type="text" name="nombre_medicamento_modal" id="nombre_medicamento_modal" required class="form-input-tailwind">
        </div>
        <div>
          <label for="tipo_medicamento_modal" class="form-label">{% translate "Tipo de Medicamento" %} <span class="text-red-500">*</span></label>
          <select name="tipo_medicamento_modal" id="tipo_medicamento_modal" required class="form-select-tailwind select2-simple">
            <option value="">{% translate "Seleccione..." %}</option>
            {% for tipo in tipos_medicamento_existentes %}
            <option value="{{ tipo.pk }}">{{ tipo.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="precio_modal" class="form-label">{% translate "Precio" %} <span class="text-red-500">*</span></label>
            <input type="number" name="precio_modal" id="precio_modal" step="0.01" min="0" value="0.00" required class="form-input-tailwind">
          </div>
          <div>
            <label for="cantidad_modal" class="form-label">{% translate "Stock Inicial" %} <span class="text-red-500">*</span></label>
            <input type="number" name="cantidad_modal" id="cantidad_modal" min="0" value="0" required class="form-input-tailwind">
          </div>
        </div>
        <div>
          <label for="concentracion_modal" class="form-label">{% translate "Concentración (Ej: 500mg)" %}</label>
          <input type="text" name="concentracion_modal" id="concentracion_modal" class="form-input-tailwind">
        </div>
        <div>
            <label for="via_administracion_modal" class="form-label">{% translate "Vía de Administración" %} <span class="text-red-500">*</span></label>
            <select name="via_administracion_modal" id="via_administracion_modal" required class="form-select-tailwind">
                <option value="">{% translate "Seleccione..." %}</option>
                <option value="oral">{% translate "Oral" %}</option>
                <option value="sublingual">{% translate "Sublingual" %}</option>
                <option value="topica">{% translate "Tópica" %}</option>
                <option value="inhalatoria">{% translate "Inhalatoria" %}</option>
                <option value="intravenosa">{% translate "Intravenosa" %}</option>
                <option value="intramuscular">{% translate "Intramuscular" %}</option>
                <option value="subcutanea">{% translate "Subcutánea" %}</option>
                <option value="intratecal">{% translate "Intratecal" %}</option>
                <option value="intraarticular">{% translate "Intraarticular" %}</option>
                <option value="rectal">{% translate "Rectal" %}</option>
                <option value="oftalmica">{% translate "Oftálmica" %}</option>
                <option value="nasal">{% translate "Nasal" %}</option>
                <option value="otra">{% translate "Otra" %}</option>
            </select>
        </div>
        <p class="text-xs text-gray-500 mt-2">{% translate "Los campos marcados con" %} <span class="text-red-500">*</span> {% translate "son obligatorios." %}</p>
    </form>
    <div class="modal-footer-custom">
        <button type="button" id="cancelarCrearMedicamentoBtn" class="btn-secondary-custom text-sm py-2 px-4">{% translate "Cancelar" %}</button>
        <button type="submit" form="formCrearMedicamento" id="guardarNuevoMedicamentoBtnSubmit" class="btn-primary-custom text-sm py-2 px-4">{% translate "Guardar Medicamento" %}</button>
    </div>
  </div>
</div>

{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {

    // --------------------- UTILIDADES COMUNES ---------------------
    function toggleModal(modalId, show = true) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.toggle('hidden', !show);
    }

    function resetForm(formElement) {
        if(formElement) {
            formElement.reset();
            formElement.querySelectorAll('.error-message').forEach(e => e.remove());
            $(formElement).find('.select2-simple').val(null).trigger('change'); // Para Select2 dentro de modales
        }
    }

    function mostrarErrores(formElement, errors) {
        if(!formElement) return;
        formElement.querySelectorAll('.error-message').forEach(e => e.remove());

        for (const campo in errors) {
            const inputName = campo.endsWith('_modal') ? campo : `${campo}_modal`; // Adaptar a nombres de campo en modales
            const input = formElement.querySelector(`[name=${inputName}], [name=${campo}]`);
            if (input) {
                const errorContainer = document.createElement('p');
                errorContainer.classList.add('error-message', 'text-red-600', 'text-xs', 'italic', 'mt-1');
                let errorText = "";
                if (Array.isArray(errors[campo])) {
                    errorText = errors[campo].map(e => e.message || e).join(', ');
                } else if (typeof errors[campo] === 'string') {
                    errorText = errors[campo];
                }
                errorContainer.textContent = errorText;
                const parent = $(input).data('select2') ? $(input).next('.select2-container').parent() : $(input).parent();
                parent.append(errorContainer);
            }
        }
         if (errors['__all__']) {
            const generalErrorDiv = document.createElement('div');
            generalErrorDiv.classList.add('error-message', 'mb-3', 'p-3', 'bg-red-100', 'text-red-700', 'text-sm', 'rounded-md');
            generalErrorDiv.textContent = errors['__all__'].join(', ');
            formElement.prepend(generalErrorDiv);
        }
    }

    function getCSRFToken() {
        return document.querySelector('#atencionForm input[name="csrfmiddlewaretoken"]').value;
    }

    // --------------------- RECONOCIMIENTO DE VOZ ---------------------
    (function voiceRecognition() {
        const btn = document.getElementById('startVoiceComentario');
        const textarea = document.getElementById('id_comentario_adicional'); // Asumiendo que widget_tweaks o Crispy genera este ID
        if (!btn || !textarea) return;

        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            btn.style.display = 'none';
            console.warn('Este navegador no soporta reconocimiento de voz.');
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        const icon = btn.querySelector('i');
        recognition.lang = 'es-ES';
        recognition.interimResults = true;
        recognition.continuous = false;

        let isRecognizing = false;
        const originalIconClass = icon.className;
        const recordingIconClass = 'fas fa-stop-circle animate-pulse text-red-500';

        btn.addEventListener('click', function () {
            if (isRecognizing) {
                recognition.stop();
            } else {
                textarea.focus();
                try { recognition.start(); }
                catch (e) {
                    console.error("Error al iniciar reconocimiento: ", e); recognition.abort();
                    Swal.fire('Error', 'No se pudo iniciar el reconocimiento de voz. Verifique permisos.', 'error');
                }
            }
        });
        recognition.onstart = () => { isRecognizing = true; icon.className = recordingIconClass; btn.title = "Detener grabación"; };
        recognition.onerror = (event) => { if (event.error !== 'no-speech' && event.error !== 'aborted') Swal.fire('Error', `Error en reconocimiento: ${event.error}`, 'error');};
        recognition.onend = () => { isRecognizing = false; icon.className = originalIconClass; btn.title = "Grabar comentario por voz"; };
        recognition.onresult = (event) => {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
            }
            if (finalTranscript) {
                const currentVal = textarea.value;
                const separator = (currentVal.length > 0 && !currentVal.endsWith(' ')) ? ' ' : '';
                textarea.value += separator + finalTranscript.trim() + ' ';
            }
        };
    })();

    // --------------------- SELECT2 PARA CAMPO PACIENTE ---------------------
    const pacienteDisplayInput = $('#paciente_nombre_display'); // Este es el input visible para Select2
    const pacienteHiddenDjangoInput = $('#id_paciente');    // Este es el <input type="hidden" name="paciente"> de Django

    if (pacienteDisplayInput.length) {
        pacienteDisplayInput.select2({
            placeholder: '{% translate "Buscar paciente por nombre, apellido o DNI..." %}',
            minimumInputLength: 2,
            allowClear: true,
            // theme: "bootstrap-5", // Descomentar si se usa el tema de Bootstrap 5 para Select2
            ajax: {
                url: "{% url 'doctor:ajax_search_patient_by_name' %}",
                dataType: 'json',
                delay: 300,
                data: params => ({ term: params.term, page: params.page || 1 }),
                processResults: (data, params) => ({
                    results: data.results.map(p => ({ id: p.id, text: p.text, full_data: p.full_data })),
                    pagination: { more: data.pagination.more }
                }),
                cache: true
            },
            escapeMarkup: markup => markup,
        }).on('select2:select', function (e) {
            var data = e.params.data;
            if (data && data.id) {
                pacienteHiddenDjangoInput.val(data.id).trigger('change'); // Actualizar el campo oculto de Django
                if (data.full_data) {
                    const p = data.full_data;
                    $('#infoPacienteSeleccionado').html(`
                        <h4 class="font-semibold text-indigo-700 mb-2 text-sm">{% translate "Info. del Paciente:" %}</h4>
                        <p><strong>{% translate "Nombre:" %}</strong> ${p.primer_nombre || ''} ${p.apellido || ''}</p>
                        <p><strong>{% translate "DNI:" %}</strong> ${p.dni || 'N/A'}</p>
                        <p><strong>{% translate "Edad:" %}</strong> ${p.edad_calculada || 'N/A'} {% translate "años" %}</p>
                        <p><strong>{% translate "Teléfono:" %}</strong> ${p.phone || 'N/A'}</p>`);
                }
            }
        }).on('select2:unselect', function (e) {
            pacienteHiddenDjangoInput.val('').trigger('change'); // Limpiar el campo oculto
            $('#infoPacienteSeleccionado').html(`<p class="italic text-gray-500 py-4">{% translate "Seleccione un paciente para ver sus detalles aquí." %}</p>`);
        });

        // Inicializar con valor existente si estamos editando
        const initialPacienteId = pacienteHiddenDjangoInput.val();
        const initialPacienteNombre = pacienteDisplayInput.data('initial-text') || ("{{ form.paciente_nombre.value|escapejs }}" || "");
        if (initialPacienteId && initialPacienteNombre) {
            var option = new Option(initialPacienteNombre, initialPacienteId, true, true);
            pacienteDisplayInput.append(option).trigger('change');
        }
    }

    // --------------------- SELECT2 PARA DIAGNÓSTICOS ---------------------
    const diagnosticoSelect = $('.select2-diagnosticos');
    if (diagnosticoSelect.length) {
        diagnosticoSelect.select2({
            placeholder: '{% translate "Seleccionar diagnósticos..." %}',
            width: '100%',
            allowClear: true,
            // theme: "bootstrap-5", // Descomentar si se usa el tema de Bootstrap 5 para Select2
        });
    }

    // --------------------- MEDICAMENTOS: SELECT2 Y FORMSET ---------------------
    let currentMedicamentoSelect2Target = null;

    function initializeMedicamentoSelect2(selector) {
        const $selector = $(selector);
        if ($selector.hasClass('select2-hidden-accessible')) $selector.select2('destroy');

        $selector.select2({
            placeholder: '{% translate "Buscar medicamento..." %}',
            minimumInputLength: 1,
            allowClear: true,
            width: '100%',
            // theme: "bootstrap-5",
            ajax: {
                url: "{% url 'doctor:ajax_search_medicamento' %}",
                dataType: 'json',
                delay: 250,
                data: params => ({ term: params.term }),
                processResults: data => ({ results: data.results.map(m => ({ id: m.id, text: m.text })) || [] }),
                cache: true
            }
        }).on('select2:select', function(e) {
            const data = e.params.data;
            const formRow = $(this).closest('.detalle-form');
            formRow.find('input[name$="-medicamento"]').val(data.id);
        }).on('select2:unselect', function(e) {
            const formRow = $(this).closest('.detalle-form');
            formRow.find('input[name$="-medicamento"]').val('');
        });
    }

    $('#detalleAtencionFormset .detalle-form').each(function() {
        const formRow = $(this);
        const selectDisplay = formRow.find('.medicamento-select2'); // El select visible
        const hiddenInput = formRow.find('input[name$="-medicamento"]'); // El input hidden de Django
        const initialMedicamentoId = hiddenInput.val();

        initializeMedicamentoSelect2(selectDisplay);

        if (initialMedicamentoId) {
            // Para el valor inicial, necesitamos el texto. La vista AJAX debería poder buscar por ID.
            $.ajax({
                type: 'GET',
                url: "{% url 'doctor:ajax_search_medicamento' %}",
                data: { 'id_exacto': initialMedicamentoId } // La vista AJAX debe soportar este param
            }).then(function (data) {
                if (data.results && data.results.length > 0) {
                    var med = data.results[0];
                    var option = new Option(med.text, med.id, true, true);
                    selectDisplay.append(option).trigger('change');
                }
            });
        }
    });
    
    (function() { // IIFE para el manejo del formset
        const formsetContainer = document.getElementById('detalleAtencionFormset');
        const addButton = document.getElementById('addDetalleAtencion');
        const templateNode = document.getElementById('detalleAtencionTemplate'); // Es un <template>
        const totalFormsInput = document.querySelector('input[name="detalles-TOTAL_FORMS"]');
        const formsetPrefix = "detalles";

        if (!formsetContainer || !addButton || !templateNode || !totalFormsInput) {
            console.error('Elementos del formset no encontrados.');
            return;
        }

        addButton.addEventListener('click', function() {
            let formNum = parseInt(totalFormsInput.value);

            const newFormHtml = templateNode.innerHTML.replace(/__prefix__/g, formNum);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newFormHtml;
            const newFormElement = tempDiv.firstElementChild;

            newFormElement.setAttribute('data-prefix', formNum);
            formsetContainer.appendChild(newFormElement);

            $(newFormElement).find('.medicamento-select2').each(function() {
                initializeMedicamentoSelect2(this);
            });

            totalFormsInput.value = formNum + 1;
        });

        formsetContainer.addEventListener('click', function(event) {
            const removeButton = event.target.closest('.remove-form-row-dynamic');
            if (removeButton) {
                const formRow = removeButton.closest('.detalle-form');
                const deleteCheckbox = formRow.querySelector(`input[name$="-DELETE"]`);

                if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                    formRow.style.display = 'none';
                } else {
                    formRow.remove();
                }
            }
        });

        formsetContainer.addEventListener('change', function(event) {
            if (event.target.matches('input[type="checkbox"][name$="-DELETE"]')) {
                const formRow = event.target.closest('.detalle-form');
                if (formRow) {
                    if (event.target.checked) {
                        formRow.style.opacity = '0.5';
                        formRow.querySelectorAll('input:not([type="checkbox"]), select:not(.select2-hidden-accessible), textarea').forEach(el => el.disabled = true);
                        $(formRow).find('.medicamento-select2').select2('disable');
                    } else {
                        formRow.style.opacity = '1';
                        formRow.querySelectorAll('input:not([type="checkbox"]), select:not(.select2-hidden-accessible), textarea').forEach(el => el.disabled = false);
                        $(formRow).find('.medicamento-select2').select2('enable');
                    }
                }
            }
        });
    })();

    // --- MODAL CREAR MEDICAMENTO ---
    (function() {
        const modal = document.getElementById('crearMedicamentoModal');
        const form = document.getElementById('formCrearMedicamento');
        const cancelarBtn = document.getElementById('cancelarCrearMedicamentoBtn');
        const closeBtn = document.getElementById('closeCrearMedicamentoModal');

        document.getElementById('crearNuevoMedicamentoBtn')?.addEventListener('click', () => {
            currentMedicamentoSelect2Target = null;
            resetForm(form);
            const tipoMedModalSelect = $('#tipo_medicamento_modal'); // ID del select en el modal
            if(tipoMedModalSelect.length && !tipoMedModalSelect.hasClass('select2-hidden-accessible')){
                tipoMedModalSelect.select2({
                    placeholder: "{% translate 'Seleccione tipo...' %}",
                    dropdownParent: $('#crearMedicamentoModal'),
                    width: '100%', allowClear: true,
                });
            }
            toggleModal('crearMedicamentoModal', true);
            form.querySelector('#nombre_medicamento_modal').focus();
        });

        cancelarBtn?.addEventListener('click', () => toggleModal('crearMedicamentoModal', false));
        closeBtn?.addEventListener('click', () => toggleModal('crearMedicamentoModal', false));

        form?.addEventListener('submit', function(event) {
            event.preventDefault();
            const guardarBtnSubmit = form.querySelector('button[type="submit"]');
            const originalButtonText = guardarBtnSubmit.innerHTML;
            guardarBtnSubmit.disabled = true;
            guardarBtnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> {% translate "Guardando..." %}';
            form.querySelectorAll('.error-message').forEach(e => e.remove());

            fetch("{% url 'doctor:ajax_crear_medicamento' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRFToken() },
                body: new FormData(form),
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success' && data.medicamento_id) {
                    Swal.fire('{% translate "¡Éxito!" %}',`{% translate "Medicamento:" %} ${data.medicamento_nombre} {% translate "creado." %}`,'success');
                    toggleModal('crearMedicamentoModal', false);
                    resetForm(form);

                    if (currentMedicamentoSelect2Target && currentMedicamentoSelect2Target.length) {
                        const newOption = new Option(data.medicamento_text, data.medicamento_id, true, true);
                        currentMedicamentoSelect2Target.append(newOption).trigger('change');
                        const formRow = currentMedicamentoSelect2Target.closest('.detalle-form');
                        formRow.find('input[name$="-medicamento"]').val(data.medicamento_id);
                    } else {
                         Swal.fire('{% translate "Info" %}',`${data.medicamento_nombre} {% translate "añadido. Selecciónelo en la lista." %}`,'info');
                    }
                    currentMedicamentoSelect2Target = null;
                } else {
                    let errorsObj = data.errors;
                    if (typeof data.errors === 'string') {
                        try { errorsObj = JSON.parse(data.errors); } catch (e) { console.error("Error parsing errors JSON", e); errorsObj = {'general': [data.message || '{% translate "Error desconocido" %}']}; }
                    }
                    mostrarErrores(form, errorsObj || {'general': [data.message || '{% translate "No se pudo crear el medicamento." %}']});
                }
            })
            .catch(err => {
                console.error('Error en fetch crear medicamento:', err);
                Swal.fire('{% translate "Error de Conexión" %}', '{% translate "Error inesperado. Revise la consola." %}', 'error');
            })
            .finally(() => {
                guardarBtnSubmit.disabled = false;
                guardarBtnSubmit.innerHTML = originalButtonText;
            });
        });
    })();

    // --- MODAL CREAR PACIENTE ---
    (function() {
        const modal = document.getElementById('crearPacienteModal');
        const form = document.getElementById('formCrearPaciente');
        const pacienteDisplaySelect2 = $('#paciente_nombre_display');
        const closeBtn = document.getElementById('closeCrearPacienteModal');

        document.getElementById('abrirCrearPacienteBtn')?.addEventListener('click', () => {
            resetForm(form);
            toggleModal('crearPacienteModal', true);
            form.querySelector('#id_primer_nombre_modal').focus();
        });

        document.getElementById('cancelarCrearPacienteBtn')?.addEventListener('click', () => toggleModal('crearPacienteModal', false));
        closeBtn?.addEventListener('click', () => toggleModal('crearPacienteModal', false));
        modal?.addEventListener('click', e => { if (e.target === modal) toggleModal('crearPacienteModal', false); });

        form?.addEventListener('submit', function(event) {
            event.preventDefault();
            const guardarBtn = form.querySelector('#guardarNuevoPacienteBtn');
            const originalButtonText = guardarBtn.innerHTML;
            guardarBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> {% translate "Guardando..." %}';
            guardarBtn.disabled = true;
            form.querySelectorAll('.error-message').forEach(e => e.remove());

            fetch("{% url 'doctor:ajax_create_patient' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRFToken() },
                body: new FormData(form)
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success' && data.paciente) {
                    Swal.fire('{% translate "¡Éxito!" %}', `{% translate "Paciente" %} ${data.paciente.primer_nombre} ${data.paciente.apellido} {% translate "creado." %}`, 'success');
                    toggleModal('crearPacienteModal', false);

                    const newOption = new Option(
                        `${data.paciente.primer_nombre} ${data.paciente.apellido}${data.paciente.dni ? ' - ' + data.paciente.dni : ''}`,
                        data.paciente.id, true, true );
                    pacienteDisplaySelect2.append(newOption).trigger('change');

                    pacienteDisplaySelect2.trigger({
                        type: 'select2:select',
                        params: { data: { id: data.paciente.id, text: newOption.text, full_data: data.paciente } }
                    });
                } else {
                     let errorsObj = data.errors;
                    if (typeof data.errors === 'string') {
                        try { errorsObj = JSON.parse(data.errors); } catch (e) { console.error("Error parsing errors JSON", e); errorsObj = {'general': [data.message || '{% translate "Error desconocido" %}']}; }
                    }
                    mostrarErrores(form, errorsObj || {'general': [data.message||'{% translate "No se pudo crear el paciente." %}']});
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('{% translate "Error de Conexión" %}', '{% translate "No se pudo conectar con el servidor." %}', 'error');
            })
            .finally(() => {
                guardarBtn.innerHTML = originalButtonText;
                guardarBtn.disabled = false;
            });
        });
    })();

    // --- MODAL PREVISUALIZACIÓN ---
    (function() {
        const previsualizacionModal = document.getElementById('previsualizacionModal');
        const previsualizacionContenido = document.getElementById('previsualizacionContenido');
        const cerrarPrevisualizacionBtn = document.getElementById('cerrarPrevisualizacionBtn');
        const closePrevisualizacionModalBtn = document.getElementById('closePrevisualizacionModal');
        // const abrirPrevisualizacionBtn = document.getElementById('abrirPrevisualizacionBtn'); // Si tuvieras un botón dedicado

        // if(abrirPrevisualizacionBtn) {
        //     abrirPrevisualizacionBtn.addEventListener('click', function() {
        //         previsualizacionContenido.innerHTML = `<p class="text-sm text-gray-500 italic">{% translate "Cargando previsualización..." %}</p>`;
        //         toggleModal('previsualizacionModal', true);
        //         fetch("{% url 'doctor:ajax_previsualizar_atencion' %}", {
        //             method: 'POST',
        //             headers: { 'X-CSRFToken': getCSRFToken() },
        //             body: new FormData(document.getElementById('atencionForm'))
        //         })
        //         .then(response => response.json())
        //         .then(data => {
        //             if (data.status === 'success') {
        //                 previsualizacionContenido.innerHTML = data.html_preview;
        //             } else {
        //                 previsualizacionContenido.innerHTML = `<p class="text-red-500">Error: ${data.message || 'No se pudo cargar la previsualización.'}</p>`;
        //             }
        //         })
        //         .catch(error => {
        //             console.error('Error fetching preview:', error);
        //             previsualizacionContenido.innerHTML = `<p class="text-red-500">{% translate "Error al cargar la previsualización." %}</p>`;
        //         });
        //     });
        // }
        cerrarPrevisualizacionBtn?.addEventListener('click', () => toggleModal('previsualizacionModal', false));
        closePrevisualizacionModalBtn?.addEventListener('click', () => toggleModal('previsualizacionModal', false));
        previsualizacionModal?.addEventListener('click', e => { if (e.target === previsualizacionModal) toggleModal('previsualizacionModal', false);});
    })();

    // Inicializar Select2 para diagnósticos que ya está en el DOM
    const diagnosticoSelectGlobal = $('.select2-diagnosticos');
    if (diagnosticoSelectGlobal.length > 0 && !diagnosticoSelectGlobal.hasClass('select2-hidden-accessible')) {
        diagnosticoSelectGlobal.select2({
            placeholder: '{% translate "Seleccionar diagnósticos..." %}',
            width: '100%',
            allowClear: true,
            // theme: "bootstrap-5",
        });
    }
});
</script>
{% endblock js %}
